#!/bin/bash

VERSION=2.0.0

current_working_dir=`pwd`
bashdot_config_file=$HOME/.bashdot

# Files will not be symlinked by bashdot
ignored_files="README.md"

action=$1

usage() {
    case $1 in
        commands)
            echo "Usage: `basename $0` [dir|install|links|profiles|uninstall|version] OPTIONS"
            ;;
        install)
            echo "Usage: `basename $0` install PROFILE1 PROFILE2 ... PROFILEN"
            ;;
        uninstall)
            echo "Usage: `basename $0` uninstall DIRECTORY PROFILE"
            ;;
    esac
}

if [ "$action" != "dir" ] &&
    [ "$action" != "install" ] &&
    [ "$action" != "links" ] &&
    [ "$action" != "profiles" ] &&
    [ "$action" != "uninstall" ] &&
    [ "$action" != "version" ]; then
    usage commands
    exit 1
fi

install() {
    profile=$1
    profiles_dir=$current_working_dir/profiles
    profile_dir=$profiles_dir/$profile


    if [ ! -d $profiles_dir ]; then
        echo "Directory profiles does not exist in '$current_working_dir'."
        exit 1
    fi

    if [ ! -d $profile_dir ]; then
        echo "Profile '$profile' directory does not exist."
        exit 1
    fi

    echo "Adding dotfiles profile '$profile'."

    echo "Checking for exiting dotfiles."
    cd $profile_dir
    for file in `ls |grep -v $ignored_files`; do
        dotfile=~/.$file
        source_file=$profile_dir/$file
        if [ -e $dotfile ]; then
            existing=`readlink $dotfile`

            # Skip files which already link to the same location
            if [ "$existing" == "$source_file" ]; then
                continue
            fi

            echo "File '$dotfile' already exists, exiting."
            exit 1
        fi
    done
    echo "Found no existing dotfiles in home."

    if [ -f $bashdot_config_file ]; then
        grep $current_working_dir $bashdot_config_file > /dev/null

        if [ $? -ne 0 ]; then
            echo "Appending bashdot '$current_working_dir' to '$bashdot_config_file'"
            echo $current_working_dir >> $bashdot_config_file
        fi
    else
        echo $current_working_dir > $bashdot_config_file
    fi

    echo "Installing dotfiles from '$profiles_dir'."
    for file in `ls |grep -v $ignored_files`; do
        dotfile=~/.$file
        source_file=$profile_dir/$file
        existing=`readlink $dotfile`

        if [ "$existing" == "$source_file" ]; then
            echo "File '$dotfile' is the same, continuing."
            continue
        fi
        echo "Linking '$source_file' to '$dotfile'."
        ln -s $source_file $dotfile
    done

    echo "Completed adding dotfiles profile '$profile'."
}

list_links() {
    for i in $(ls -a ~); do

        # Only evaluate symlinks
        if [[ -h ~/$i ]]; then

            # Only include if it points to the dotfiles directory
            for bashdot_dir in $(cat $bashdot_config_file); do
                readlink ~/$i |grep $bashdot_dir > /dev/null
                if [ $? -eq 0 ];then
                    echo $i
                fi
            done
        fi
    done
}

list_profiles() {
    if [ ! -f $bashdot_config_file ];then
        echo "No dotfiles installed by bashdot."
    else
        for dir in $(cat $bashdot_config_file); do
            for link in $(list_links); do
                readlink ~/$link | grep $dir > /dev/null
                if [ $? -eq 0 ]; then
                    profile=`readlink ~/$link |sed -e "s/^.*\/profiles\/\(.*\)\/.*$/\1/"`
                    echo "$dir $profile"
                fi
            done
        done |sort |uniq
    fi
}

show_links() {
    for link in $(list_links); do
        dest=`readlink ~/$link`
        chomped_link="${link%\\n}"
        echo "~/$chomped_link -> $dest"
    done
}

dir() {
    if [ ! -f $bashdot_config_file ];then
        echo "No dotfiles installed by bashdot."
    else
        cat $bashdot_config_file |sort
    fi
}

uninstall() {
    dir=$1
    profile=$2

    if [ ! -f $bashdot_config_file ]; then
        echo "Config file '$bashdot_config_file' not found."
        echo "No dotfiles installed by bashdot."
        exit 1
    fi

    # Don't proceed with uninstall if profiles not available in given directory
    list_profiles |grep "^$dir $profile$"
    if [ $? -ne 0 ];then
        echo "Profile '$profile' not installed from '$dir'."
        exit 1
    fi

    # Loop through each file and only remove if they are a symlink
    # and point to a file in this profile in the target dir
    for link in $(list_links);do
        echo `readlink ~/$link` |grep ^$dir/profiles/$profile > /dev/null
        if [ $? -eq 0 ]; then
            echo "Removing '$link'."
            \rm ~/$link
        fi
    done

    # If no more profiles point to this directory, remove it
    dir_empty=true
    for link in $(list_links); do
        echo `readlink ~/$link` |grep ^$dir/profiles > /dev/null
        if [ $? -eq 0 ]; then
            dir_empty=false
        fi
    done

    if [ "$dir_empty" = true ]; then
        echo "Removing '$dir' from '$bashdot_config_file'."
        mv $bashdot_config_file ${bashdot_config_file}.backup
        cat ${bashdot_config_file}.backup |grep -v "^$dir$" > $bashdot_config_file
    fi

    # If there are no more bashdot profiles, remove .bashdot and backup
    if [ ! -s $bashdot_config_file ]; then
        \rm -f $bashdot_config_file ${bashdot_config_file}.backup
    fi
}

case $action in
    dir)
        dir
        ;;
    install)
        if [ $# -lt 2 ]; then
            usage install
            exit 1
        fi

        while true; do
            shift

            if [ -z $1 ];then
                break
            fi

            install $1
        done

        echo "Completed installation of all profiles succesfully."
        ;;
    links)
        show_links
        ;;
    profiles)
        list_profiles
        ;;
    uninstall)
        if [ $# -lt 3 ]; then
            usage uninstall
            exit 1
        fi
        uninstall $2 $3
        echo "Completed uninstallation succesfully."
        ;;
    version)
        echo $VERSION
        ;;
esac
